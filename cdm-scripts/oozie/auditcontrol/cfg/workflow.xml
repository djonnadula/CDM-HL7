<workflow-app name="cdm-bd-${WF_NAME}" xmlns="uri:oozie:workflow:0.5">
    <credentials>
        <credential name="hcat" type="hcat">
            <property>
                <name>hcat.metastore.uri</name>
                <value>thrift://xrdcldbdm010001.unix.medcity.net:9083</value>
            </property>
            <property>
                <name>hcat.metastore.principal</name>
                <value>hive/xrdcldbdm010001.unix.medcity.net@HCA.CORPAD.NET</value>
            </property>
        </credential>
    </credentials>
    <start to="run-shell-script"/>
    <action name="Kill">
        <email xmlns="uri:oozie:email-action:0.2">
            <to>${EMAIL}</to>
            <subject>${ENVIRONMENT}: ${wf:name()} Job Failure</subject>
            <body>The ${wf:name()} Oozie job has failed.
                JobId: ${wf:id()}
                JobPath: ${wf:appPath()}
                ErrorMessage: ${wf:errorMessage(wf:lastErrorNode())}
            </body>
        </email>
        <ok to="Kill-kill"/>
        <error to="Kill-kill"/>
    </action>
    <kill name="Kill-kill">
        <message>Action failed, error message[${wf:errorMessage(wf:lastErrorNode())}]</message>
    </kill>
    <action name="run-shell-script" cred="hcat">
        <shell xmlns="uri:oozie:shell-action:0.1">
            <job-tracker>${jobTracker}</job-tracker>
            <name-node>${nameNode}</name-node>
            <configuration>
                <property>
                    <name>oozie.action.max.output.data</name>
                    <value>16384</value>
                </property>
            </configuration>
            <exec>${SCRIPT_PATH}</exec>
            <file>${FILE_PATH}</file>
            <capture-output/>
        </shell>
        <ok to="success-or-fail-email"/>
        <error to="Kill"/>
    </action>
    <action name="success-email">
        <email xmlns="uri:oozie:email-action:0.2">
            <to>${EMAIL}</to>
            <subject>${ENVIRONMENT}: CDM_BD_Audit Results</subject>
            <body>Results: Please find attached.
Job start time: ${AuditStartDate}
Job end time:   ${timestamp()}
            </body>
            <content_type>text/plain</content_type>
            <attachment>result1.txt</attachment>
        </email>
        <ok to="End"/>
        <error to="Kill"/>
    </action>
    <action name="fail-email">
        <email xmlns="uri:oozie:email-action:0.2">
            <to>${EMAIL}</to>
            <subject>${ENVIRONMENT}: CDM_BD_Audit Job Failure</subject>
            <body>CDM_BD_Audit Job Failure has failed.</body>
            <content_type>text/plain</content_type>
        </email>
        <ok to="End"/>
        <error to="Kill"/>
    </action>
    <decision name="success-or-fail-email">
        <switch>
            <case to="success-email">
              ${ 1 gt 0 }
            </case>
            <default to="fail-email"/>
        </switch>
    </decision>
    <end name="End"/>
</workflow-app>