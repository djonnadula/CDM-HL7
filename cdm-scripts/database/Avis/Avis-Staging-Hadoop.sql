CREATE EXTERNAL TABLE if not exists hl7.hl7_avis(
sending_facility String,
sending_application String,
patient_mrn String,
patient_urn String,
patient_account_number String,
date_time_of_birth String,
patient_family_name String,
patient_given_name String,
sex String,
date_time_of_message String,
hl7_type String,
message_event String,
message_control_id String,
processing_id String,
version_id String,
character_set String,
patient_class String,
assigned_patient_location String,
obsv_date_time_num String,
relevant_clinical_information String,
set_id String,
value_type String,
obsv_id String,
obsv_value String,
units String,
obsv_result_status String,
user_defined_access_checks String,
date_time_of_the_obsv String,
deviceType String,
assigned_patient_location_point_of_care String,
assigned_patient_location_point_of_care_namespace_id String,
assigned_patient_location_point_of_care_universal_id String,
assigned_patient_location_point_of_care_universal_id_type String,
assigned_patient_location_room String,
assigned_patient_location_room_namespace_id String,
assigned_patient_location_room_universal_id String,
assigned_patient_location_room_universal_id_type String,
assigned_patient_location_bed String,
assigned_patient_location_bed_namespace_id String,
assigned_patient_location_bed_universal_id String,
assigned_patient_location_bed_universal_id_type String,
assigned_patient_location_facility String,
assigned_patient_location_facility_namespace_id String,
assigned_patient_location_facility_universal_id String,
assigned_patient_location_facility_universal_id_type String,
assigned_patient_location_location_status String,
assigned_patient_location_person_location_type String,
assigned_patient_location_building String,
assigned_patient_location_building_namespace_id String,
assigned_patient_location_building_universal_id String,
assigned_patient_location_building_universal_id_type String,
assigned_patient_location_floor String,
assigned_patient_location_floor_namespace_id String,
assigned_patient_location_floor_universal_id String,
assigned_patient_location_floor_universal_id_type String,
assigned_patient_location_location_description String,
assigned_patient_location_comprehensive_location_id String,
assigned_patient_location_comprehensive_location_id_entity_id String,
assigned_patient_location_comprehensive_location_id_namespace_id String,
assigned_patient_location_comprehensive_location_id_universal_id String,
assigned_patient_location_comprehensive_location_id_universal_id_type String,
assigned_patient_location_assigning_authority_for_location String,
assigned_patient_location_assigning_authority_for_location_namespace_id String,
assigned_patient_location_assigning_authority_for_location_universal_id String,
assigned_patient_location_assigning_authority_for_location_universal_id_type String,
etl_insert_date_time STRING
)
PARTITIONED BY (
	message_type String,
	transaction_date String
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '|'
STORED AS SEQUENCEFILE
LOCATION '/user/hive/warehouse/hl7/landing_zone=ADHOC-AVIS-DELIMITED';


Drop Table if exists hl7.hl7_avis_staging PURGE;

MSCK REPAIR TABLE hl7.hl7_avis;

CREATE TABLE hl7.hl7_avis_staging(
sending_facility String,
sending_application String,
patient_mrn String,
patient_urn String,
patient_account_number String,
date_time_of_birth String,
patient_family_name String,
patient_given_name String,
sex String,
date_time_of_message String,
hl7_type String,
message_event String,
message_control_id String,
processing_id String,
version_id String,
character_set String,
patient_class String,
assigned_patient_location String,
obsv_date_time_num String,
relevant_clinical_information String,
set_id String,
value_type String,
obsv_id String,
obsv_value String,
units String,
obsv_result_status String,
user_defined_access_checks String,
date_time_of_the_obsv String,
deviceType String,
assigned_patient_location_point_of_care String,
assigned_patient_location_point_of_care_namespace_id String,
assigned_patient_location_point_of_care_universal_id String,
assigned_patient_location_point_of_care_universal_id_type String,
assigned_patient_location_room String,
assigned_patient_location_room_namespace_id String,
assigned_patient_location_room_universal_id String,
assigned_patient_location_room_universal_id_type String,
assigned_patient_location_bed String,
assigned_patient_location_bed_namespace_id String,
assigned_patient_location_bed_universal_id String,
assigned_patient_location_bed_universal_id_type String,
assigned_patient_location_facility String,
assigned_patient_location_facility_namespace_id String,
assigned_patient_location_facility_universal_id String,
assigned_patient_location_facility_universal_id_type String,
assigned_patient_location_location_status String,
assigned_patient_location_person_location_type String,
assigned_patient_location_building String,
assigned_patient_location_building_namespace_id String,
assigned_patient_location_building_universal_id String,
assigned_patient_location_building_universal_id_type String,
assigned_patient_location_floor String,
assigned_patient_location_floor_namespace_id String,
assigned_patient_location_floor_universal_id String,
assigned_patient_location_floor_universal_id_type String,
assigned_patient_location_location_description String,
assigned_patient_location_comprehensive_location_id String,
assigned_patient_location_comprehensive_location_id_entity_id String,
assigned_patient_location_comprehensive_location_id_namespace_id String,
assigned_patient_location_comprehensive_location_id_universal_id String,
assigned_patient_location_comprehensive_location_id_universal_id_type String,
assigned_patient_location_assigning_authority_for_location String,
assigned_patient_location_assigning_authority_for_location_namespace_id String,
assigned_patient_location_assigning_authority_for_location_universal_id String,
assigned_patient_location_assigning_authority_for_location_universal_id_type String,
etl_insert_date_time String
)
row format delimited
fields terminated by '|'
stored as textfile;

INSERT INTO hl7.hl7_avis_staging
Select
sending_facility String,
sending_application String,
patient_mrn String,
patient_urn String,
patient_account_number String,
date_time_of_birth String,
patient_family_name String,
patient_given_name String,
sex String,
date_time_of_message,
hl7_type,
message_event,
message_control_id,
processing_id,
version_id,
character_set,
patient_class,
assigned_patient_location,
obsv_date_time_num,
relevant_clinical_information,
set_id,
value_type,
obsv_id,
obsv_value,
units,
obsv_result_status,
user_defined_access_checks,
date_time_of_the_obsv,
deviceType,
assigned_patient_location_point_of_care,
assigned_patient_location_point_of_care_namespace_id,
assigned_patient_location_point_of_care_universal_id,
assigned_patient_location_point_of_care_universal_id_type,
assigned_patient_location_room,
assigned_patient_location_room_namespace_id,
assigned_patient_location_room_universal_id,
assigned_patient_location_room_universal_id_type,
assigned_patient_location_bed,
assigned_patient_location_bed_namespace_id,
assigned_patient_location_bed_universal_id,
assigned_patient_location_bed_universal_id_type,
assigned_patient_location_facility,
assigned_patient_location_facility_namespace_id,
assigned_patient_location_facility_universal_id,
assigned_patient_location_facility_universal_id_type,
assigned_patient_location_location_status,
assigned_patient_location_person_location_type,
assigned_patient_location_building,
assigned_patient_location_building_namespace_id,
assigned_patient_location_building_universal_id,
assigned_patient_location_building_universal_id_type,
assigned_patient_location_floor,
assigned_patient_location_floor_namespace_id,
assigned_patient_location_floor_universal_id,
assigned_patient_location_floor_universal_id_type,
assigned_patient_location_location_description,
assigned_patient_location_comprehensive_location_id,
assigned_patient_location_comprehensive_location_id_entity_id,
assigned_patient_location_comprehensive_location_id_namespace_id,
assigned_patient_location_comprehensive_location_id_universal_id,
assigned_patient_location_comprehensive_location_id_universal_id_type,
assigned_patient_location_assigning_authority_for_location,
assigned_patient_location_assigning_authority_for_location_namespace_id,
assigned_patient_location_assigning_authority_for_location_universal_id,
assigned_patient_location_assigning_authority_for_location_universal_id_type,
etl_insert_date_time
From hl7.hl7_avis
WHERE sending_facility != '100' and sending_facility != '200'  and patient_mrn != '' and patient_urn != '' and patient_account_number != '' and  patient_family_name != '' and patient_given_name != ''
and transaction_date >=  '${hiveconf:transactiondate}'  and etl_insert_date_time >= '${hiveconf:offset}';


