package com.hca.cdm.hl7.parser

import com.hca.cdm.Models.MSGMeta
import com.hca.cdm._
import com.hca.cdm.hl7.model._
import com.hca.cdm.hl7.audit.AuditConstants._
import com.hca.cdm.hl7.audit._
import com.hca.cdm.hl7.constants.HL7Constants._
import com.hca.cdm.hl7.constants.HL7Types.{withName => hl7}
import com.hca.cdm.log.Logg
import org.apache.log4j.PropertyConfigurator._

import scala.util.{Failure, Success, Try}
import com.hca.cdm.mq.publisher.{MQAcker => TLMAcknowledger}

import scala.collection.mutable.ListBuffer
/**
  * Created by Devaraj Jonnadula on 8/24/2016.
  */
object HL7LocalRunner extends App with Logg {
  case object StringType


  configure(currThread.getContextClassLoader.getResource("local-log4j.properties"))
  reload(null,Some(currThread.getContextClassLoader.getResourceAsStream("Hl7LocalConfig.properties")))
  val msgType = hl7("ORU")
    // hl7(args(0))
  val hl7Messages = new ListBuffer[String]()
   // loadHl7FromFile(hl7Messages,readFile("C:\\Users\\pzi7542\\Requirements\\SCRI-Radilogy\\Copy of query-impala-33002.txt").getLines().span(_.startsWith("\r\nMSH")))
  hl7Messages
  private val msgs =
      "MSH|^~\\&||COCMSO|||201706280131||ORU^R01|MT_COCMSO_ORU_SHAGTPACS.1.28332|P|2.1\nPID|1||E000009969|E5778|MCCOY^JOHN^RANDALL^^^||19550502|M||||||||||E26000312865|223-82-5562\nPV1|1|E|E.ED^^||||GORJON^Gorbach^Jonathan^S^^^MD^^^^^^^^^(240)686-2300|.SELF^REFERRED^SELF^^^^|.NO PCP^PHYSICIAN^NO^PRIMARY OR FAMILY^^^||||||||^^^^^^|ER|||||||||||||||||||||COCMSO||REG|||||||||||.SELF^REFERRED^SELF^^^^\nORC|RE||||S|N|||||||COCMSO^SSHC\nOBR|1|000029929&N&N| - CT HEAD BRAIN WO IV CON|CHETUBECT^ - CT HEAD BRAIN WO IV CON^CT|S|201706280037|201706280124|201706280124||||||||GORJON|(240)686-2300||||||||F||||||^altered LOC|DR.KUMAR&&&&&&^^201706280127||||201706280036\nZUR|1|E5778\nZUR|2|E000029929\nZUR|3|restwebpx1.hca.corpad.net\nZUR|4|COCMSO\nOBX|1|TX|000029929^ - CT HEAD BRAIN WO IV CON^HD|1| ~  StoneSprings Hospital Center      Name: MCCOY,JOHN RANDALL            ~  24440 StoneSprings Boulevard      Phys: Gorbach,Jonathan S  MD        ~  Dulles, VA 20166                  DOB: 05/02/1955   Age: 62       Sex: M~                                    Acct: E26000312865  Loc: E.ED      ~  PHONE #:                          Exam Date: 06/28/2017 Status: REG ER  ~    FAX #:                          Radiology No:           ~                                Unit No: E000009969    ~ ~ ~ ~  EXAMS:                                                              ~  000029929 CT HEAD BRAIN WO IV CON                                   ~ ~       CT HEAD WITHOUT CONTRAST:   ~        ~     HISTORY:  Syncope and headaches  ~        ~     TECHNIQUE:    ~     2.5 mm axial images through the posterior fossa, and 5 mm cuts images  ~     through the remainder of the brain without contrast administration.  ~        ~     COMPARISON: None  ~        ~     FINDINGS:    ~     Brain volume is appropriate for patient's age.  No evidence of  ~     hydrocephalus.  No abnormal densities in the brain parenchyma.  The  ~     grey white matter differentiation is preserved.  No evidence of  ~     hemorrhage, mass, mass effect or abnormal extra axial fluid  ~     collection.  ~        ~     Mucosal thickening within the ethmoidal air cells.  The mastoid air  ~     cells are clear.  The orbits are unremarkable.  The calvarium and  ~     skull base are intact. 7 mm mildly lucent lesion within the left  ~     frontal calvarium (image 43 of series 3)  ~        ~       IMPRESSION:    ~       1. No acute intracranial process.   ~       2. Mild ethmoid sinus disease  ~       3. 7 mm lucent lesion within the left frontal calvarium. Findings  ~       likely represent a hemangioma or other benign etiology. Recommend bone  ~       scan if there is concern for pathology  ~          ~          ~          ~       Thank you for allowing us to participate in the care of your patient.  ~       Please note that this CT was performed using the most up-to-date dose  ~       reduction software and techniques (including automated exposure  ~       control, adjustment of the MA and/or kV according to patient size, and  ~       iterative reconstruction technique) in accordance with our continuing  ~       efforts to minimize radiation dose while maximizing the diagnostic  ~       quality of our images.  ~          ~          ~          ~          ~          ~            ~ ~ ~ ~PAGE  1                       Signed Report                    (CONTINUED)~ ~ ~  StoneSprings Hospital Center      Name: MCCOY,JOHN RANDALL            ~  24440 StoneSprings Boulevard      Phys: Gorbach,Jonathan S  MD        ~  Dulles, VA 20166                  DOB: 05/02/1955   Age: 62       Sex: M~                                    Acct: E26000312865  Loc: E.ED      ~  PHONE #:                          Exam Date: 06/28/2017 Status: REG ER  ~    FAX #:                          Radiology No:           ~                                Unit No: E000009969    ~ ~ ~ ~  EXAMS:                                                              ~  000029929 CT HEAD BRAIN WO IV CON                                   ~   <Continued>~ ~     ~** Electronically Signed by M.D. ARUN KUMAR on 06/28/2017 at 0127 **  ~                    Reported and signed by: ARUN KUMAR, M.D.    ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~CC:                                                                   ~                                                                      ~Dictated Date/Time: 06/28/2017 (0124)~Technologist: NYNITO D MAJEED; Shawn Houser, CT                      ~Transcribed Date/Time: 06/28/2017 (0124)~Transcriptionist: DR.KUMAR                           ~Orig Print D/T: S: 06/28/2017 (0131)                        ~                                     BATCH NO: N/A       ~ ~PAGE  2                       Signed Report                               "
      //"MSH|^~\\&||COCNB|||201706040801||ORU^R01|MT_COCNB_ORU_NBGTPACS.1.1518289|P|2.1\nPID|1||F090582149|G361023|URSPRUCH^CHARLES^F^^^||19511226|M||||||||||F45005614632|142-42-2260\nPV1|1|E|F.ER^^||||SAIDA^Saintsing^David^E^^^MD^^^^^^^^^(303)436-2727|.SELF^REFERRED^SELF^^^^|.NO PCP^PHYSICIAN^NO^PRIMARY OR FAMILY^^^||||||||^^^^^^|ER|||||||||||||||||||||COCNB||REG|||||||||||.SELF^REFERRED^SELF^^^^\nORC|RE||||S|N|||||||COCNB^MAIN\nOBR|1|001497724&N&N| - CTA CHEST WWO |ANGCHWWO^ - CTA CHEST WWO ^CT|S|201706040712|201706040756|201706040756||||||||aOGGCH|(303)436-2727|.NO PCP~.SELF~SAIDA~aOGGCH|||||||F||||||^TR - Trauma|DR.BRAJOL&&&&&&^^201706040800||||201706040712\nZUR|1|G361023\nZUR|2|F1497724\nZUR|3|gcsswpwebgep02.hca.corpad.net\nZUR|4|COCNB\nOBX|1|TX|001497724^ - CTA CHEST WWO ^ANGCHWWO|1| ~ ~ PATIENT NAME: URSPRUCH,CHARLES F            ~      UNIT NO: F090582149    ~ ~   EXAMS:                                                              ~   001497724 CTA CHEST WWO                                             ~ ~ ~       CTA OF THE CHEST WITH IV CONTRAST - CPT 74175 (1.82)  ~     TECHNIQUE: Images were obtained of the chest following the intravenous  ~     injection of contrast. MPR and 3D images were produced.   ~     CT dose lowering techniques were used, to include: automated exposure  ~     control, adjustment for patient size, and or use of iterative  ~     reconstruction.   ~     CONTRAST DOSE: 100 mL Isovue-370  ~        ~     INDICATION: Chest tightness.  ~        ~     COMPARISON: None available.  ~        ~     FINDINGS:  ~        ~     PULMONARY ARTERIES: The pulmonary arteries are well opacified. No  ~     filling defects are demonstrated. Main pulmonary artery measures 3.5  ~     cm, moderately enlarged.  ~        ~     CARDIOVASCULAR SYSTEM: Trace pericardial effusion noted. Normal heart  ~     size. Normal origin of the coronary arteries. Normal opacification of  ~     the thoracic aorta, with left-sided arch. Normal pulmonary venous  ~     return.  ~        ~     MEDIASTINUM AND HILA: Mild distal esophageal wall thickening noted.  ~     Central airways are clear. The thyroid is unremarkable. No hilar or  ~     mediastinal lymphadenopathy.  ~        ~     LUNGS AND PLEURA:  Mild to moderate apical predominant centrilobular  ~     emphysema is demonstrated. Minimal subsegmental atelectasis noted in  ~     the lung bases. No consolidation.  ~        ~     UPPER ABDOMEN: Gallbladder resected. Gastric bypass surgery noted.  ~     Normal appearance of the gastrojejunostomy. This passes anterior to  ~     the transverse colon.  ~        ~     BODY WALL: Unremarkable.  ~        ~     BONES:  No acute osseous lesions.  ~        ~       IMPRESSION:   ~       1.  No pulmonary embolism.    ~ ~ ~   NORTH SUBURBAN MAIN DEPARTMENT      NAME: URSPRUCH,CHARLES F            ~   DIAGNOSTIC IMAGING DEPARTMENT       HP: (201)244-6159   AGE: 65      S:M~   9191 GRANT                          DOB: 12/26/1951  LOC: F.ER      ~   THORNTON, COLORADO 80229            PHYS: aOGGCH - Oggel,Christian James~   PHONE #: (303)45O-4477              EXAM DATE: 06/04/2017 STATUS: REG ER~     FAX #: (303)450-4613              A#: F45005614632      U#: F090582149~ ~ PAGE  1                       Signed Report                   (CONTINUED) ~ ~ ~ ~ ~ PATIENT NAME: URSPRUCH,CHARLES F            ~      UNIT NO: F090582149    ~ ~   EXAMS:                                                              ~   001497724 CTA CHEST WWO                                             ~    <Continued>~ ~ ~         2.  Moderately enlarged pulmonary artery suggestive of pulmonary  ~       hypertension.  ~       3.  Mild to moderate centrilobular emphysema.  ~          ~       SLOT 88  ~          ~       Jon Brandon, M.D.6/4/2017 8:00 AM  ~            ~ ~     ~          ** Electronically Signed by Jonathan Brandon MD **  ~          **             on 06/04/2017 at 0800            **  ~                    Reported and signed by: Jonathan Brandon MD    ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ CC: NO PRIMARY OR FAMILY PHYSICIAN; SELF REFERRED;                    ~     David E Saintsing MD; Christian James PA Oggel                    ~ TECHNOLOGIST: Tammy King RT(R,CT)                                    ~ TRANSCRIBED DATE/Time: 06/04/2017 0756 BY: DR.BRAJOL           ~ EXAM COMPLETE DATE/TIME: 20170604   0750        D/TM:06/04/2017 (0801)~ ~ ~   NORTH SUBURBAN MAIN DEPARTMENT      NAME: URSPRUCH,CHARLES F            ~   DIAGNOSTIC IMAGING DEPARTMENT       HP: (201)244-6159   AGE: 65      S:M~   9191 GRANT                          DOB: 12/26/1951  LOC: F.ER      ~   THORNTON, COLORADO 80229            PHYS: aOGGCH - Oggel,Christian James~   PHONE #: (303)45O-4477              EXAM DATE: 06/04/2017 STATUS: REG ER~     FAX #: (303)450-4613              A#: F45005614632      U#: F090582149~ ~ PAGE  2                       Signed Report                   *Final Page*~ "
      //"MSH|^~\\&||COCNB|||201706040801||ORU^R01|MT_COCNB_ORU_NBGTPACS.1.1518289|P|2.1\nPID|1||F090582149|G361023|URSPRUCH^CHARLES^F^^^||19511226|M||||||||||F45005614632|142-42-2260\nPV1|1|E|F.ER^^||||SAIDA^Saintsing^David^E^^^MD^^^^^^^^^(303)436-2727|.SELF^REFERRED^SELF^^^^|.NO PCP^PHYSICIAN^NO^PRIMARY OR FAMILY^^^||||||||^^^^^^|ER|||||||||||||||||||||COCNB||REG|||||||||||.SELF^REFERRED^SELF^^^^\nORC|RE||||S|N|||||||COCNB^MAIN\nOBR|1|001497724&N&N| - CTA CHEST WWO |ANGCHWWO^ - CTA CHEST WWO ^CT|S|201706040712|201706040756|201706040756||||||||aOGGCH|(303)436-2727|.NO PCP~.SELF~SAIDA~aOGGCH|||||||F||||||^TR - Trauma|DR.BRAJOL&&&&&&^^201706040800||||201706040712\nZUR|1|G361023\nZUR|2|F1497724\nZUR|3|gcsswpwebgep02.hca.corpad.net\nZUR|4|COCNB\nOBX|1|TX|001497724^ - CTA CHEST WWO ^ANGCHWWO|1| ~ ~ PATIENT NAME: URSPRUCH,CHARLES F            ~      UNIT NO: F090582149    ~ ~   EXAMS:                                                              ~   001497724 CTA CHEST WWO                                             ~ ~ ~       CTA OF THE CHEST WITH IV CONTRAST - CPT 74175 (1.82)  ~     TECHNIQUE: Images were obtained of the chest following the intravenous  ~     injection of contrast. MPR and 3D images were produced.   ~     CT dose lowering techniques were used, to include: automated exposure  ~     control, adjustment for patient size, and or use of iterative  ~     reconstruction.   ~     CONTRAST DOSE: 100 mL Isovue-370  ~        ~     INDICATION: Chest tightness.  ~        ~     COMPARISON: None available.  ~        ~     FINDINGS:  ~        ~     PULMONARY ARTERIES: The pulmonary arteries are well opacified. No  ~     filling defects are demonstrated. Main pulmonary artery measures 3.5  ~     cm, moderately enlarged.  ~        ~     CARDIOVASCULAR SYSTEM: Trace pericardial effusion noted. Normal heart  ~     size. Normal origin of the coronary arteries. Normal opacification of  ~     the thoracic aorta, with left-sided arch. Normal pulmonary venous  ~     return.  ~        ~     MEDIASTINUM AND HILA: Mild distal esophageal wall thickening noted.  ~     Central airways are clear. The thyroid is unremarkable. No hilar or  ~     mediastinal lymphadenopathy.  ~        ~     LUNGS AND PLEURA:  Mild to moderate apical predominant centrilobular  ~     emphysema is demonstrated. Minimal subsegmental atelectasis noted in  ~     the lung bases. No consolidation.  ~        ~     UPPER ABDOMEN: Gallbladder resected. Gastric bypass surgery noted.  ~     Normal appearance of the gastrojejunostomy. This passes anterior to  ~     the transverse colon.  ~        ~     BODY WALL: Unremarkable.  ~        ~     BONES:  No acute osseous lesions.  ~        ~       IMPRESSION:   ~       1.  No pulmonary embolism.    ~ ~ ~   NORTH SUBURBAN MAIN DEPARTMENT      NAME: URSPRUCH,CHARLES F            ~   DIAGNOSTIC IMAGING DEPARTMENT       HP: (201)244-6159   AGE: 65      S:M~   9191 GRANT                          DOB: 12/26/1951  LOC: F.ER      ~   THORNTON, COLORADO 80229            PHYS: aOGGCH - Oggel,Christian James~   PHONE #: (303)45O-4477              EXAM DATE: 06/04/2017 STATUS: REG ER~     FAX #: (303)450-4613              A#: F45005614632      U#: F090582149~ ~ PAGE  1                       Signed Report                   (CONTINUED) ~ ~ ~ ~ ~ PATIENT NAME: URSPRUCH,CHARLES F            ~      UNIT NO: F090582149    ~ ~   EXAMS:                                                              ~   001497724 CTA CHEST WWO                                             ~    <Continued>~ ~ ~         2.  Moderately enlarged pulmonary artery suggestive of pulmonary  ~       hypertension.  ~       3.  Mild to moderate centrilobular emphysema.  ~          ~       SLOT 88  ~          ~       Jon Brandon, M.D.6/4/2017 8:00 AM  ~            ~ ~     ~          ** Electronically Signed by Jonathan Brandon MD **  ~          **             on 06/04/2017 at 0800            **  ~                    Reported and signed by: Jonathan Brandon MD    ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ CC: NO PRIMARY OR FAMILY PHYSICIAN; SELF REFERRED;                    ~     David E Saintsing MD; Christian James PA Oggel                    ~ TECHNOLOGIST: Tammy King RT(R,CT)                                    ~ TRANSCRIBED DATE/Time: 06/04/2017 0756 BY: DR.BRAJOL           ~ EXAM COMPLETE DATE/TIME: 20170604   0750        D/TM:06/04/2017 (0801)~ ~ ~   NORTH SUBURBAN MAIN DEPARTMENT      NAME: URSPRUCH,CHARLES F            ~   DIAGNOSTIC IMAGING DEPARTMENT       HP: (201)244-6159   AGE: 65      S:M~   9191 GRANT                          DOB: 12/26/1951  LOC: F.ER      ~   THORNTON, COLORADO 80229            PHYS: aOGGCH - Oggel,Christian James~   PHONE #: (303)45O-4477              EXAM DATE: 06/04/2017 STATUS: REG ER~     FAX #: (303)450-4613              A#: F45005614632      U#: F090582149~ ~ PAGE  2                       Signed Report                   *Final Page*~ "
      //"MSH|^~\\&||COCMT|||201706100022||ORU^R01|MT_COCMT_ORU_MTGTPACS.1.1260230|P|2.1\nPID|1||M01017177|M512144|GALINDO^JOEL^^^^||19590808|M||||||||||M263865528|777-77-7777\nPV1|1|E|M.ER^^||||MCCSTD^Mcconnell^Stephen^D^^^MD^^^^^^^^^(214)712-2084|.SELF^REFERRED^SELF^^^^|.DNK^KNOW^DOES^NOT^^^||||||||^^^^^^|ER|||||||||||||||||||||COCMT||REG|||||||||||EDDOC^EMERGENCY^DOCTOR^^^^\nORC|RE||||D|N|||||||COCMT^MTCAMP\nOBR|1|001426498&N&N| - CT Chest/Abdomen w IV Cont|XCHEABD1^ - CT Chest/Abdomen w IV Cont^CT|S|201706092330|201706100021|201706100021||||||||PFIKEM|(214)712-2084||||||||P||||||^|||||201706092330\nZUR|1|M01017177\nZUR|2|16239717\nZUR|3|STHM0SQL01\nZUR|4|COCMT\nOBX|1|TX|001426498^ - CT Chest/Abdomen w IV Cont^XCHEABD1|1| ~  Metropolitan Hospital                   NAME: GALINDO,JOEL                ~  1310 McCullough Avenue                  PHYS: Pfister,Kevin M  PA-C       ~  San Antonio, TX 78212                   DOB: 08/08/1959 AGE: 57      SEX:M~                                          ACCT: M263865528    LOC: M.ER     ~    PHONE #: (210)757-2284                EXAM DATE: 06/09/2017 ST: REG ER  ~      FAX #: (210)757-2184                UNIT NO: M01017177     ~                                      EXAM COMPLETE:     ~ ~ ~ ~ ~  EXAMS:                                                              ~  001426498 CT Chest/Abdomen w IV Cont                                ~ ~  The radiologists report is available in Primordial.    ~ ~     ~                \"\"                                          ~               Reported by: Monica A. Dalrymple, M.D.  ~    ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~ ~CC:                                                                   ~                                                                      ~TECHNOLOGIST:                               ~TRANSCRIBED DATE/TIME: 06/10/2017 (0021)~TRANSCRIPTIONIST: TRANS                              ~PRINTED DATE/TIME: 06/10/2017 (0022)   BATCH NO: N/A       ~ ~PAGE  1                       Draft Report                                "
      //"MSH|^~\\&||COCSO|||201706060953||ORU^R01|MT_COCSO_ORU_SOGTPACS.1.937793|P|2.1\nPID|1||H000457712|H378755|CAROTHERS^GLADYS^ODELL^^^||19390719|F||||||||||H00318356032|412-70-0507\nPV1|1|O|H.CT^^||||KUHKA^Kuhn^Karl^P^^^MD^^^^^^^^^615-834-9781|KUHKA^Kuhn^Karl^P^^^MD|OSBTR^Osborne^Tracy^J^^^MD||||||||^^^^^^|CLI|||||||||||||||||||||COCSO||REG\nORC|RE||||S|N|||||||COCSO^M\nOBR|1|001730661&N&N| - CT CHEST W/O CONTRAST    71250|CHECT^ - CT CHEST W/O CONTRAST    71250^CT|R|201706060854|201706060945|201706060945||||||||KUHKA|615-834-9781|KUHKA|||||||F||||||^PULMONARY NODULE, F/U|DR.NICMI&&&&&&^^201706060951||||201706060854\nZUR|1|H000457712\nZUR|2|COCSO001730661\nZUR|3|trdvsynweb.hca.corpad.net\nZUR|4|COCSO\nOBX|1|TX|001730661^ - CT CHEST W/O CONTRAST    71250^CHECT|1| ~  SOUTHERN HILLS MEDICAL CENTER     Name: CAROTHERS,GLADYS ODELL        ~  DEPARTMENT OF MEDICAL IMAGING     Phys: Kuhn,Karl P  MD               ~  391 WALLACE ROAD                  DOB: 07/19/1939   Age: 77       Sex: F~  NASHVILLE, TN  37211              Acct: H00318356032  Loc: H.CT      ~  PHONE #: 615-781-4650             Exam Date: 06/06/2017 Status: REG CLI ~    FAX #: 615-781-3585             Radiology No: 00443205  ~                                Unit No: H000457712    ~ ~ ~  EXAMS:                               Reason:                          ~001730661 CT CHEST W/O CONTRAST      PULMONARY NODULE, F/U              ~ ~ ~       CT CHEST WITHOUT CONTRAST; 6/6/2017 8:54 AM  ~        ~     HISTORY: Pulmonary nodule follow-up  ~        ~     COMPARISON: CT of the chest 12/6/2016 as well as multiple priors  ~        ~     TECHNIQUE: Helical CT was performed of the chest from the lung apices  ~     through the upper abdomen without IV contrast. Reformatted images were  ~     provided in the coronal plane.  ~        ~     FINDINGS:  ~     The heart size is normal. There is no pericardial effusion.  ~        ~     A heterogeneous opacity in the right upper lobe with surrounding usual  ~     markers measures 18 x 14 mm (from 17 x 15 mm on prior examination.  ~     A 5 mm noncalcified nodule in the left lung base is unchanged from  ~     2014, consistent with a benign etiology.  ~        ~     The upper abdominal contents are unremarkable.  ~        ~          ~        ~       IMPRESSION:  ~       Interval placement of fiducial markers surrounding the right upper  ~       lobe opacity which is not appreciably changed in size or density  ~       compared to the most recent examination. Close interval follow-up is  ~       recommended.    ~ ~     ~          ** Electronically Signed by Michael Nichols MD **  ~          **            on 06/06/2017 at 0951            **  ~                    Reported and signed by: Michael Nichols, MD    ~ ~      ~ ~ ~ ~CC: Karl Philip Kuhn, MD                                              ~                                                                      ~Dictated Date/Time: 06/06/2017 (0945)~Technologist: PAYNE,JACKIE                                           ~Transcribed Date/Time: 06/06/2017 (0945)~CTDI:17.53               DLP:398.02~Electronic Signature Date/Time: 06/06/2017 (0951)~Orig Print D/T: S: 06/06/2017 (0953)                        ~                                     BATCH NO: N/A       ~ ~PAGE  1                       Signed Report                               "
   //"MSH|^~\\&|IMG_RESULT|MSLP||IMG_RESULT|20170630110925|EDIRADIN|ORU^R01|EPIC_MSLP_ORU_3669490|P|2.1||Epic_Mountain_PRD|||||||\nPID|1|W173439^^SLCURN^SLCURN|1000661485^EPIC^MRN|D000010054^MCC^MCC~W000266661^SMHP^SnMHP|MCKENNEY-DAVIES^SUSANNA^CLARA||19670522|F|BLUMER^SUSANNA^C~MCKENNEYDAVIES^SUSANNA^CLARA^~MCKENNEY DAVIES^SUSANNA^|W|366 N 1200 EPLEASANT GROVE^UT^84062^USA^P^UTAH|UTAH|(801)859-4955^P^H|(801)268-7119^P^W||M||100331415|074-62-9371|||||||||||\nPD1|||LONE PEAK HOSPITAL^10002001|BENRI^BENNETT^RICHARD^W^^^PROVID^^PROVID~MAQ9147^BENNETT^RICHARD^W^^^THREEFOUR^^^THREEFOUR||||||||||||\nPV1||O|MSLPRD^^MSLP^^^^^||||BENRI^BENNETT^RICHARD^W^^^PROVID^^PROVID~MAQ9147^BENNETT^RICHARD^W^^^THREEFOUR^^THREEFOUR|BENRI^BENNETT^RICHARD^W^^^PROVID^^PROVID~MAQ9147^BENNETT^RICHARD^W^^^THREEFOUR^^^THREEFOUR|||||||||||30227288|||||||||||||||||||||||||20170630104430|||||||V\nORC|RE|796251^EPC|MSLP849741^EPC||Final||^^20170630110055^20170630110115^R||20170630110925|EDIRADIN^INTERFACE^RAD^RESULTS IN||BENRI^BENNETT^RICHARD^W^^^^PROVID^^PROVID~MAQ9147^BENNETT^RICHARD^W^^^THREEFOUR^^THREEFOUR|10002001006^10002001^^^^UT LP XR|(801)572-0311|||||||||||||||I\nOBR|1|796251^EPC|MSLP849741^EPC|IMG115^XR HIP 2-3V LEFT^RAD^XR HIP 2+ VW|R|20170630104431|||||Ancillary Pe|||||BENRI^BENNETT^RICHARD^W^^^PROVID^^PROVID~MAQ9147^BENNETT^RICHARD^W^^^THREEFOUR^^THREEFOUR|(801)572-0311|||||20170630110800||RG|Final||^20170630110055^20170630110115^R||||^Annual Physical exam|PANCO^PANUSHKA^COLE^J^^^Composed1^^Composed1~PANCO^PANUSHKA^COLE^J^^^Composed2^^Composed2~PANCO^PANUSHKA^COLE^J^^^PROVID^^PROVID~MMI9374^PANUSHKA^COLE^J^^^THREEFOUR^^THREEFOUR||BBI7712^JONES^CHELSEA||20170630104500||||||||IMG115^XR HIP 2-3V LEFT^RADXR HIP 2+ VW|LT(used to identify procedures performed on the left side of\nOBX|1|ST|&GDT|1|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|2|ST|&GDT|1|XR HIP 2-3V LEFT||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|3|ST|&GDT|1|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|4|ST|&GDT|1|HISTORY: 50 years old Female with history of left hip pain||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|5|ST|&GDT|1|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|6|ST|&GDT|1|COMPARISON: 10/15/2008||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|7|ST|&GDT|1|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|8|ST|&GDT|1|FINDINGS: ||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|9|ST|&GDT|1|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|10|ST|&GDT|1|AP pelvis with abducted view of the left hip. Joints appear symmetric. Bony pelvis appears normal. There is no fracture dislocation. The articulating surfaces are smooth and normal contour.||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|11|ST|&GDT|1|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|12|ST|&IMP|2|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|13|ST|&IMP|2|IMPRESSION:||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|14|ST|&IMP|2|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|15|ST|&IMP|2|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|16|ST|&IMP|2|Normal appearance the pelvis and left hip. No fracture dislocation.||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|17|ST|&IMP|2|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|18|ST|&IMP|2|** Electronically Signed by Cole Panushka, MD on 6/30/2017 11:08 AM **||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|19|ST|&GDT|2|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|20|ST|&GDT|2|Electronically Signed By Cole J Panushka, MD on 6/30/2017 11:08||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|21|ST|&GDT|2|||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nOBX|22|ST|&TCM|3|Px in left hip; trauma injury few years ago; kni injury since then; px comes and goes for last few years||||||Final||||9|BBI7712^JONES^CHELSEA^^||\nZDS|1.2.840.114350.2.340.2.798268.2.796251.1^EPIC^APPLICATION^DICOM"
      //"MSH|^~\\&||COCSED|||201706291402||ORU^R01|MT_COCMHB_ORU_MHBGTPACS.1.631968|P|2.1\nPID|1||D004822367|D264324|SANCHEZ DE FUENTES^JUANA^^^^||19310131|F||||||||||D61005364659|262-98-9334\nPV1|1|I|D.IRF^D.4114^1||||PEPTE^Peppard^Terence^R^^^MD^^^^^^^^^305-285-2977|PEPTE^Peppard^Terence^R^^^MD|PEPTE^Peppard^Terence^R^^^MD||||||||PEPTE^Peppard^Terence^R^^^MD^^^^^^^^^305-285-2977|IN|||||||||||||||||||||COCMHB||ADM|||||||||||PEPTE^Peppard^Terence^R^^^MD~ALIHA^Ali^Hassan^^^^MD~BAQHE^Baquerizo^Hernan^R^^^MD~DURMA^Duran Borras^Manuel^A^^^MD~GAREF^Garcia^Efrain^^^^MD~GONHU^Gonzalez^Hugo^F^^^MD~HANDA^Hansra^Damien^M^^^MD~HORJE^Horstmyer^Jeffrey^L^^^MD~HOUPA^Hourani^Patrick^^^^MD~NGUPH^Nguyen^Phu^H^^^DPM~PIGRO^Pigalarga^Rodolfo^^^^MD~SHASO^Shah^Somal^S^^^MD~SOSEV^Sosa^Evelio^H^^^MD\nORC|RE||||S|N|||||||COCMHB^MAIN\nOBR|1|000690652&N&N| - CT ABDOMEN AND PELVIS W CONT|ABDPELCREC^ - CT ABDOMEN AND PELVIS W CONT^CT|R|201706281653|201706291357|201706291357||||||||NOTKH|305-351-8080|NOTKH|||||||F||||||^anorectal mass|BAIBR&Baigorri&Brian&F&&&MD^^201706291357||||201706291653\nZUR|1|BD264324\nZUR|2|BD000690652\nZUR|3|KRMCWPWEB1.hca.corpad.net\nZUR|4|COCMHB\nOBX|1|TX|000690652^ - CT ABDOMEN AND PELVIS W CONT^ABDPLVO|1| ~  Mercy Hospital Main               Name: SANCHEZ DE FUENTES,JUANA      ~  3663 South Miami Avenue           Phys: Noto, Khristian A MD          ~  Miami, Florida  33133             DOB:  01/31/1931   Age: 86      Sex: F~                                    Acct: D61005364659 Loc: D.4114 1  ~  PHONE #: 305-854-4400             Exam Date: 06/29/2017 Status: ADM IN  ~    FAX #:                          Unit: D004822367     PACS: BD264324   ~                                Exam Completed: 06/29/17   @ 1140~                                                                    ~ ~ ~ ~  EXAMS:                                               CPT:           ~000690651 CT CHEST W CONTRAST                        71260            ~000690652 CT ABDOMEN AND PELVIS W CONT               74177            ~ ~       HISTORY:                                                                ~     Rectal mass                                                             ~                                                                             ~     Exam:                                                                   ~     CT thorax with contrast                                                 ~     CT abdomen and pelvis with contrast                                     ~                                                                             ~     Technique:                                                              ~     Following intravenous administration of iodinated contrast medium,  ~     axial images of the thorax, abdomen, pelvis were obtained.  Coronal  ~     and sagittal reconstructions were performed. The CT scanners at Mercy  ~     Hospital, a campus of Plantation General Hospital, are equipped with  ~     Automatic Exposure Control Technology to reduce the radiation  ~     exposure to the patient.  DLP = 997.73  ~                                                                             ~     Comparison:                                                             ~     None                                                                    ~                                                                             ~     Findings:                                                               ~     Thorax:                                                                 ~     The thoracic aorta is nonaneurysmal.  There is a three-vessel arch.   ~     The heart is prominent.  There is a moderate pericardial effusion.  ~     There is no significant mediastinal or hilar adenopathy.  There is no  ~     axillary adenopathy.  Though not performed per pulmonary embolus  ~     protocol, there are no central pulmonary arterial filling defects to  ~     suggest an embolus.  ~                                                                             ~     There is no pneumothorax.  There is a moderate left pleural effusion  ~     with complete left lower lobe atelectasis.  There is dependent  ~     atelectasis in the left upper lobe.  Dependent right lower lobe  ~     atelectasis is present. The left upper lobe scarring is unchanged.  ~                                                                             ~     Abdomen/pelvis:                                                         ~     The liver, pancreas, and adrenal glands are not enlarged demonstrate  ~     no masses.  There is no intrahepatic biliary ductal dilatation.   ~     Choleliths are present. The portal vein is patent.  There is a low  ~     attenuation involving the superomedial spleen.  ~                                                                             ~     The kidneys are not enlarged.  There is no hydronephrosis.  Cortical  ~     attenuation is symmetric. The unenhanced urinary bladder contains an  ~     indwelling Foley catheter however is not decompressed.  The uterus is  ~     not enlarged.  There are no adnexal masses.  ~                                                                             ~     There is no ascites or pneumoperitoneum.  There is no intestinal    ~ ~PAGE  1                       Signed Report                    (CONTINUED)~ ~ ~  Mercy Hospital Main               Name: SANCHEZ DE FUENTES,JUANA      ~  3663 South Miami Avenue           Phys: Noto, Khristian A MD          ~  Miami, Florida  33133             DOB:  01/31/1931   Age: 86      Sex: F~                                    Acct: D61005364659 Loc: D.4114 1  ~  PHONE #: 305-854-4400             Exam Date: 06/29/2017 Status: ADM IN  ~    FAX #:                          Unit: D004822367     PACS: BD264324   ~                                Exam Completed: 06/29/17   @ 1140~                                                                    ~ ~ ~ ~  EXAMS:                                               CPT:           ~000690651 CT CHEST W CONTRAST                        71260            ~000690652 CT ABDOMEN AND PELVIS W CONT               74177            ~   <Continued>~ ~       obstruction. There are no secondary findings to suggest appendicitis.  ~                                                                             ~     The abdominal aorta is nonaneurysmal.  There is no significant  ~     retroperitoneal adenopathy.  Scattered external iliac lymph nodes are  ~     sub centimeter in short axis dimension. At the gastroesophageal  ~     junction there is a prominent lymph node 1 cm in short axis dimension.  ~                                                                             ~     Small epigastric fat-containing hernia is present. Multilevel  ~     thoracic spine and lumbar spine degenerative changes are  ~     redemonstrated.  ~                                                                             ~       IMPRESSION::                                                            ~                                                                               ~       1.  Increase in size of a moderate left pleural effusion. Stable  ~       small right pleural effusion.  ~       2.  Complete left lower lobe atelectasis.  Other areas of dependent  ~       subsegmental atelectasis in the left upper lobe and dependent right  ~       lung.  ~       3.  Mild/moderate pericardial effusion.                                 ~       4.  New infarct involving the superomedial spleen.                      ~       5.  Fat-containing ventral hernia.                                      ~       6.  Distended urinary bladder in the setting of an indwelling Foley  ~       catheter.  Please correlate with possibly kinked or clamped Foley.  ~       7.  Cholelithiasis.                                                     ~       8.  Rectal wall thickening.  Correlation with digital rectal exam  ~       advised.  ~                                                                                 ~ ~     ~         ** Electronically Signed by M.D. Brian F Baigorri **  ~         **              on 06/29/2017 at 1357             **  ~                    Reported and signed by: Brian F Baigorri, M.D.    ~ ~ ~ ~CC: Khristian A MD Noto                                               ~                                                                      ~Dictated Date/Time: 06/29/2017 (1357)~Technologist: D. ABREU; M. GARCIA-FLORES                             ~Transcribed Date/Time: 06/29/2017 (1357)~Transcriptionist: UMR:RAD                            ~Electronic Signature Date/Time: 06/29/2017 (1357)~Orig Print D/T: S: 06/29/2017 (1401)                        ~ ~PAGE  2                       Signed Report                               \n"
  //    "MSH|^~\\&|COCNW|COCNW|OV|OV|201706092307||RAS^O17|IP_COCNW_RAS_PHAWF.170609.2875|P|2.5||CAC^01554||\nPID|1||AF00769225^^^COCWF^MRN|AF713617|ELHAGE^KATIA||19540601|F||||||||||AF1002484898\nPV1|1|I|AF.5W^AF.502^1^COCWF|EM|||SHARAM^Shaarawy^Rami|||||||||||IN|||||||||||||||||||||||ADM\nORC|RE|14494418|08438036||AC||^ASDIR^As Directed||201706092306|||SHARAM|||201706091855\nRXA|1|1|201706092306||POT20/100^POTASSIUM CHLORIDE 20 MEQ/100 ML STER H20 PREMIX BAG^L^00338070548A^POTASSIUM CHLORIDE 20MEQ^NDC|1|MLS|100^1|026348|AFNURIXA|||||||||Y^Y|CP|D|||||IV\nRXR|IV^INTRAVEN.|VAD\nNTE|1|CO|Difference between amount dispensed\nNTE|2|CO|and amount administered was discarded.\nZSC|1|POT20/100^0338070548^POTASSIUM CHLORIDE 20 MEQ/100 ML STER H20 PREMIX BAG^POTASSIUM CHLORIDE 20MEQ^POTASSIUM CHLORIDE\n"
     // "MSH|^~\\&||COCMO|||201706112324||ADT^A02|MT_COCMO_ADT_MOGTADM.1.15851416|P|2.1\nEVN|A02|201706112324|||GNUR.ACM3^MAGALLANEZ^ADELL^^^^\nPID|1||G000326406|G227729|WILSON^TERRY^LYNN^^^|MARIAM|19560509|F|^^^^^|W|3315 INDIAN HORSE CT^^NORTH LAS VEGAS^NV^89032^USA^^^CLARK||(702)767-8574|(702)365-7111|ENG|M|OTH|G00016436394|561-98-5748\nPV1|1|I|G.2SE^G.2019^A|EM||G.ERH^G.ED10^A|QUIDU^Quiroz^Dulce^^^^DO|.SELF^REFERRED^SELF^^^^|.NO PCP^PHYSICIAN^NO^PRIMARY OR FAMILY^^^|MED||||PR|FR|N|QUIDU^Quiroz^Dulce^^^^DO|IN||08|||||||||||||||||||COCMO|GENERALIZED WEAKNESS, HYPERGLYCEMIA, UTI|ADM|||201706112203\nAL1|1|DA|F001000815^No Known Drug Intolerances^^^allergy.id|U|NKDA|20130423\nAL1|2|DA|No Known Contrast Allergies|U||20061211\nAL1|3|DA|No Known Drug Allergies|U||20061211\nAL1|4|DA|No Known Food Allergies|U||20061211\nAL1|5|DA|No Known Other Allergies|U||20061211\nACC|20170611^|11\nDG1|1|I10|R53.1|WEAKNESS||A||||||||||||N\nGT1|1||WILSON^TERRY^LYNN^^^||3315 INDIAN HORSE CT^^NORTH LAS VEGAS^NV^89032^USA^^^CLARK|(702)767-8574||19560509|F||SA|561-98-5748|||ORLEANS HOTEL   CASINO|4500 W TROPICANA AVE.^^LAS VEGAS^NV^89103|(702)365-7111|||F\nGT1|2||^^^^^||^^^^^^^^|||||||||||^^^^\nIN1|1|BCOOS||BLUE CROSS OUT OF STATE|PO BOX 5747^^DENVER^CO^80217^USA||(877)833-5742|174172M2AS|BOYD GAMING|||20170101||||WILSON^TERRY^L^^^|01|19560509||||||||||||||||||BYM963M78509|||||||F\nZMR|1|H000059103\nZCD|1|1REG0M031A^4. Illness/injury due to work related accident/condition?^N\nZCD|2|1REG0M041A^1. Was illness/injury due to a non-work related accident?^NO\nZCD|3|1REG0M065A^Occurrence Code:^11\nZCD|4|1REG0M066A^Date:^20170611\nZCD|5|1REG0M234A^FC1:^08\nZCD|6|ETHNICITY^ETHNICITY^2\nZCD|7|ZSS.AMTREQ^AMT REQ^200.00\nZCD|8|ZSS.DEPREQ^DEPOSIT REQ?^N\nZCD|9|ZSS.ESTCHG^EST PT DUE^0.00\nZCD|10|ZSS.UNABLE^Comment if FULL amt requested NOT collected^NOT INF\nZIN|1|SP|BLUE CROSS|Y|20170611|PPI||Y|||||BCOOS\nZCS|ORLHO|4500 W TROPICANA AVE.^^LAS VEGAS^NV^89103|F|DECLINED|DECLINED|02270\n"
    //  "MSH|^~\\&|MT_COCQA1A|COCQA1A|DBM||201601190838||ADT^A02|MT_COCQA1A_ADT_QA1AGTADM.1.229576.567|D|2.5||KYA\nEVN|A02|201601190838|||1TSQBE8554^HAMMOCK^BRITTANY^^^^\nPID|1||J000423598|J500217|Jones^Jessica^Campbell^^|UNKNOWN|20031230|F|CAGE^JESSICA^CAMPBELL JONES^|U|456 MARVEL STREETFRANKLIN^TN^37064^USA^^WILLIAMSON||(615)555-6261|(615)555-6261|ENG|S|NON|J00021004053|302-30-2015\nPV1|1|I|J.DEVICU^J.DEVICU1^A|EL||J.DE2^J.DE2^229|DRFIRST^FIRST^DOCTOR^^^||DRBRI^DOCTOR^BRITTANY^^|IM||||ER||Y|ADMITTING^PHYSICIAN^TEST^ADMITTING^^|INO||08|||||||||||||||||||COCQA1A|OBSERVATION|ADM|||201601190811\nAL1|1|DA|1000031^Bee^Bee|SV|ANAPHYLAXIS|20160114\nAL1|2|DA|F006004630^sufentanil^sufentanil|MI|ANXIETY|20160114\nACC|20160119^|11\nGT1|1||Jones^Jessica^Campbell^^||456 MARVEL STREETFRANKLIN^TN^37064^USA^WILLIAMSON|(615)555-6261||20031230|F||SA|302-30-2015|||ALIAS|^^^||||FT\nGT1|2||^^^^||^^^^^^|||||||||||^^^\nIN1|1|AETNA||AETNA|10 WHITE STREET^INS ST2^ANYTOWN^TN^00111^USA||(615)825-5555|AETNA GROUP #|AETNA GROUP NAME|||||||Jones^Jessica^Campbell^^^|01|20031230||||||||||||||||||302302015|||||||F\nZCD|1|ETHNICITY^ETHNICITY^3\nZCD|2|Z.ADDLRACE^ADDITIONAL RACE^U\nZCD|3|ZSS.DEPREQ^DEPOSIT REQ?^N\nZCD|4|ZSS.UNABLE^Comment if FULL amt requested NOT collected^NR\nZCD|5|hca0000200^Reason-^2\nZCD|6|hca0000227^Able to perform TB Contagious Respiratory Infection Point of Entry Screen^N\nZIN|1|SP|AETNA INSURANCE|N||AET PRECERT CONTACT||N|||||AETNA\nZCS|ALIAS|456 MARVEL STREET^^FRANKLIN^TN^37064|FT|EMAIL@TEST.COM|EMAIL@TEST.COM|04446"
    //"MSH|^~\\&||COCHM|||201703310757||ADT^A31|MT_COCHM_ADT_TNAGTMRI.1.7325521|P|2.1\nEVN|A31|201703310757||E\nPID|1||Q002023752|Q95587|GUPTON^BRANDY^LEIGH^^^|ANGELA|19900517|F|GUPTON^BRANDY^^^^|W|2704 HWY 47 NORTH^^WHITE BLUFF^TN^37187^USA^^^DICKSO.TN||615-972-6793|615-446-8000|ENG|S|NON|Q95587|412-65-5356\nIN1|1|TC.AMERIC||TNCARE AMERICHOICE|PO BOX 5220^STE 200^KINGSTON^NY^12402-5220||800-690-1606|MT01|TNCARE AMERICHOICE|||20081001|20110516|||GUPTON^BRANDY^L^^^|01|||||||||||||||||||JD3794405\nIN1|2|TC.AMGRP||TNCARE AMERIGROUP|PO BOX 61010^TN CLAIMS^VIRGINIA BEACH^VA^23466-1010||800-454-3730|||||||||GUPTON^BRANDY^L^^^|01|||||||||||||||||||712927939\nIN1|3|TC.BC||TNCARE BLUECARE|1 CAMERON HILL CIRCLE^SUITE 0002^CHATTANOOGA^TN^37402-0002||800-276-1978|125000||||20150101||||GUPTON^BRANDY^^^^|01|||||||||||||||||||ZECM12714949\nIN1|4|TC.UHCCMPL||TNCARE UHC COMMUNITY PLAN|PO BOX 5220^^KINGSTON^NY^12402-5220||800-690-1606|MT05||||20110601||||GUPTON^BRANDY^L^^^|01|||||||||||||||||||JD3794405\nIN1|5|UNINSURED||UNINSURED DISCOUNT PLAN|552 METROPLEX DR^^NASHVILLE^TN^37211||615-886-5660|||||||||GUPTON^BRANDY^LEIGH^^^|01|||||||||||||||||||412655356\n"
    //"MSH|^~\\&||COCXG|||201701231800||RDE^O01|MT_COCXG_RDE_XGPHAORD.1.10910266|P|2.2\nPID|||J000466169|J429090|KERR^BURGRTT^ULANE^^^||19499517|||||||||||J00073669669\nPV1|I||J.PACUH^J.801^A||||LAZJE^Lazarus^Jeffrey^J MD"

  private val messageTypes = lookUpProp("hl7.messages.type") split COMMA
  private val hl7MsgMeta = messageTypes.map(mtyp => hl7(mtyp) -> getMsgTypeMeta(hl7(mtyp), lookUpProp(mtyp + ".kafka.source"))) toMap
  private val templatesMapping = loadTemplate(lookUpProp("hl7.template"))
  private val segmentsMapping = applySegmentsToAll(loadSegments(lookUpProp("hl7.segments")) ++ loadSegments(lookUpProp("hl7.adhoc-segments")), messageTypes)
  private val modelsForHl7 = hl7MsgMeta.map(msgType => msgType._1 -> segmentsForHl7Type(msgType._1, segmentsMapping(msgType._1.toString)))
  private val registeredSegmentsForHl7 = modelsForHl7.mapValues(_.models.keySet)
  private val hl7Parsers = hl7MsgMeta map (hl7 => hl7._1 -> new HL7Parser(hl7._1, templatesMapping))
  private val jsonAuditor = hl7MsgMeta map (msgType => msgType._1 -> (auditMsg(msgType._1.toString, jsonStage)(EMPTYSTR, _: MSGMeta)))
  private val segmentsAuditor = hl7MsgMeta map (msgType => msgType._1 -> (auditMsg(msgType._1.toString, segmentStage)(_: String, _: MSGMeta)))
  private val adhocAuditor = hl7MsgMeta map (msgType => msgType._1 -> (auditMsg(msgType._1.toString, adhocStage)(_: String, _: MSGMeta)))
  private val allSegmentsInHl7Auditor = hl7MsgMeta map (msgType => msgType._1 -> (auditMsg(msgType._1.toString, segmentsInHL7)(_: String, _: MSGMeta)))
  private val tlmAuditor = tlmAckMsg("test", applicationReceiving, HDFS, _: String)(_: MSGMeta)
  private val segmentsHandler = modelsForHl7 map (hl7 => hl7._1 -> new DataModelHandler(hl7._2, registeredSegmentsForHl7(hl7._1), segmentsAuditor(hl7._1),
    allSegmentsInHl7Auditor(hl7._1), adhocAuditor(hl7._1), tlmAckMsg(hl7._1.toString, applicationReceiving, HDFS, _: String)(_: MSGMeta)))
  var tlmAckIO: (String, String) => Unit = null
  modelsForHl7.filter(_._1.toString == "MDM")
    //.filter(_._2.models.filter(_._1.contains("ADHOC")))
    TLMAcknowledger("test", "test")(lookUpProp("mq.hosts"), lookUpProp("mq.manager"), lookUpProp("mq.channel"), lookUpProp("mq.destination.queues"))
    tlmAckIO = TLMAcknowledger.ackMessage(_: String, _: String)

  Try(hl7Parsers(msgType).transformHL7(msgs, reject) rec) match {
    case Success(map) =>
      map match {
        case Left(out) =>
          info("json: " + out._1)
          segmentsHandler(msgType).handleSegments(outio, reject, audit, adhocDestination,Some(tlmAckIO))(out._2,msgs, out._3)
        case Right(t) =>
          error(t);
      }
    case Failure(t) =>
      error(t)
  }
  private def loadHl7FromFile(data:ListBuffer[String] ,source: (Iterator[String],Iterator[String])) : Unit ={
    data += source._1.mkString(CRLF)
    loadHl7FromFile(data,source._2.span(_.startsWith("\r\nMSH")))

  }

  private def outio(k: String, v: String) = {
    info("outio: " + k)
  }

  private def reject(k: String, v: String) = {
    info("reject: " + k)
  }

  private def audit(k: String, v: String) = {
   // info("audit: " + k)
  }

  private def adhocDestination(k: String, v: String, dest: String) = {
    info("adhocDestiation: " + k)
  }

}





